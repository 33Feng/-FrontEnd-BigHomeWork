{"ast":null,"code":"import { withKeys as _withKeys, createVNode as _createVNode, createTextVNode as _createTextVNode, withCtx as _withCtx, createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode, toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, normalizeClass as _normalizeClass } from \"vue\";\nconst _hoisted_1 = {\n  class: \"graph-wrapper\",\n  style: {\n    \"width\": \"100%\",\n    \"height\": \"550px\",\n    \"position\": \"relative\"\n  }\n};\nconst _hoisted_2 = {\n  class: \"search-bar\",\n  style: {\n    \"margin-bottom\": \"10px\",\n    \"display\": \"flex\",\n    \"gap\": \"10px\"\n  }\n};\nconst _hoisted_3 = {\n  key: 0,\n  class: \"loading\"\n};\nconst _hoisted_4 = {\n  ref: \"graphRef\",\n  style: {\n    \"width\": \"100%\",\n    \"height\": \"100%\",\n    \"border\": \"1px solid #e6e6e6\",\n    \"border-radius\": \"8px\"\n  }\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, [_createVNode($setup[\"ElInput\"], {\n    modelValue: $setup.searchEntity,\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $setup.searchEntity = $event),\n    placeholder: \"输入节点名称搜索（如Vue、Vite、ES6）\",\n    clearable: \"\",\n    style: {\n      \"flex\": \"1\"\n    },\n    onKeyup: _withKeys($setup.handleSearch, [\"enter\"])\n  }, null, 8 /* PROPS */, [\"modelValue\"]), _createVNode($setup[\"ElButton\"], {\n    type: \"primary\",\n    onClick: $setup.handleSearch\n  }, {\n    default: _withCtx(() => [...(_cache[1] || (_cache[1] = [_createTextVNode(\"搜索\", -1 /* CACHED */)]))]),\n    _: 1 /* STABLE */\n  }), _createVNode($setup[\"ElButton\"], {\n    onClick: $setup.showAllGraph\n  }, {\n    default: _withCtx(() => [...(_cache[2] || (_cache[2] = [_createTextVNode(\"显示全部\", -1 /* CACHED */)]))]),\n    _: 1 /* STABLE */\n  }), _createCommentVNode(\" 新增：全屏按钮（带图标） \"), _createVNode($setup[\"ElButton\"], {\n    type: \"primary\",\n    onClick: $setup.toggleFullScreen,\n    icon: \"Fullscreen\",\n    circle: \"\",\n    title: \"全屏展示图谱\"\n  }, {\n    default: _withCtx(() => [...(_cache[3] || (_cache[3] = [_createTextVNode(\"全屏\", -1 /* CACHED */)]))]),\n    _: 1 /* STABLE */\n  })]), _createCommentVNode(\" 修改：给图谱容器添加动态class，用于全屏样式控制 \"), _createElementVNode(\"div\", {\n    class: _normalizeClass(['graph-container', {\n      'fullscreen': $setup.isFullScreen\n    }]),\n    style: {\n      \"width\": \"100%\",\n      \"height\": \"500px\",\n      \"position\": \"relative\"\n    }\n  }, [$setup.loading ? (_openBlock(), _createElementBlock(\"div\", _hoisted_3, _toDisplayString($setup.currentEntity ? `加载「${$setup.currentEntity}」相关图谱...` : '加载知识图谱中...'), 1 /* TEXT */)) : _createCommentVNode(\"v-if\", true), _createElementVNode(\"div\", _hoisted_4, null, 512 /* NEED_PATCH */), _createVNode($setup[\"ElButton\"], {\n    type: \"text\",\n    onClick: $setup.initGraph,\n    style: {\n      \"position\": \"absolute\",\n      \"bottom\": \"10px\",\n      \"right\": \"10px\"\n    }\n  }, {\n    default: _withCtx(() => [...(_cache[4] || (_cache[4] = [_createTextVNode(\" 重新加载 \", -1 /* CACHED */)]))]),\n    _: 1 /* STABLE */\n  })], 2 /* CLASS */)]);\n}","map":{"version":3,"names":["class","style","ref","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_createVNode","$setup","searchEntity","$event","placeholder","clearable","onKeyup","_withKeys","handleSearch","type","onClick","_cache","showAllGraph","_createCommentVNode","toggleFullScreen","icon","circle","title","_normalizeClass","isFullScreen","loading","_hoisted_3","_toDisplayString","currentEntity","_hoisted_4","initGraph"],"sources":["D:\\前端大作业\\kg-system\\frontend\\src\\components\\GraphVisual.vue"],"sourcesContent":["<template>\r\n  <div class=\"graph-wrapper\" style=\"width: 100%; height: 550px; position: relative;\">\r\n    <div class=\"search-bar\" style=\"margin-bottom: 10px; display: flex; gap: 10px;\">\r\n      <el-input\r\n        v-model=\"searchEntity\"\r\n        placeholder=\"输入节点名称搜索（如Vue、Vite、ES6）\"\r\n        clearable\r\n        style=\"flex: 1;\"\r\n        @keyup.enter=\"handleSearch\"\r\n      ></el-input>\r\n      <el-button type=\"primary\" @click=\"handleSearch\">搜索</el-button>\r\n      <el-button @click=\"showAllGraph\">显示全部</el-button>\r\n      <!-- 新增：全屏按钮（带图标） -->\r\n      <el-button \r\n        type=\"primary\" \r\n        @click=\"toggleFullScreen\"\r\n        icon=\"Fullscreen\"  \r\n        circle\r\n        title=\"全屏展示图谱\"\r\n      >全屏</el-button>\r\n    </div>\r\n\r\n    <!-- 修改：给图谱容器添加动态class，用于全屏样式控制 -->\r\n    <div :class=\"['graph-container', { 'fullscreen': isFullScreen }]\" style=\"width: 100%; height: 500px; position: relative;\">\r\n      <div v-if=\"loading\" class=\"loading\">\r\n        {{ currentEntity ? `加载「${currentEntity}」相关图谱...` : '加载知识图谱中...' }}\r\n      </div>\r\n      <div \r\n        ref=\"graphRef\" \r\n        style=\"width: 100%; height: 100%; border: 1px solid #e6e6e6; border-radius: 8px;\"\r\n      ></div>\r\n      <el-button \r\n        type=\"text\" \r\n        @click=\"initGraph\" \r\n        style=\"position: absolute; bottom: 10px; right: 10px;\"\r\n      >\r\n        重新加载\r\n      </el-button>\r\n    </div>\r\n  </div>\r\n</template>\r\n<script setup>\r\nimport { ref, onMounted, nextTick, onUnmounted, watch, defineProps, defineEmits } from 'vue';\r\nimport { api } from '../api/index';\r\nimport { Network, DataSet } from 'vis-network/standalone';\r\nimport { ElButton, ElMessage, ElInput } from 'element-plus';\r\n// 原有导入保留，新增：导入全屏图标\r\nimport { Fullscreen, FullscreenExit } from '@element-plus/icons-vue';\r\n\r\n// 接收父组件传递的核心实体\r\nconst props = defineProps({\r\n  mainEntity: {\r\n    type: String,\r\n    default: ''\r\n  }\r\n});\r\n\r\n// 向父组件发送当前选中的实体\r\nconst emit = defineEmits(['update:currentEntity']);\r\n\r\n// 响应式数据\r\nconst graphRef = ref(null);\r\nconst network = ref(null); // 图谱实例（初始为null）\r\nconst loading = ref(true);\r\nconst searchEntity = ref('');\r\nconst currentEntity = ref('');\r\n// 原有响应式数据保留，新增：全屏状态标识\r\nconst isFullScreen = ref(false); // 控制全屏状态\r\n\r\n// 销毁图谱实例（增加非空校验）\r\nconst destroyNetwork = () => {\r\n  if (network.value) {\r\n    // 先移除所有事件监听，再销毁\r\n    network.value.off('stabilizationIterationsDone');\r\n    network.value.off('click');\r\n    network.value.destroy();\r\n    network.value = null; // 销毁后重置为null\r\n  }\r\n};\r\n\r\n// 初始化图谱（核心修复：全程非空校验）\r\nconst initGraph = async (targetEntity = '') => {\r\n  try {\r\n    loading.value = true;\r\n    destroyNetwork(); // 先销毁旧实例，避免内存泄漏\r\n\r\n    // 等待DOM完全渲染\r\n    await nextTick();\r\n\r\n    // 1. 校验DOM容器\r\n    if (!graphRef.value) {\r\n      ElMessage.error('图谱容器不存在，无法初始化！');\r\n      loading.value = false;\r\n      return; // 终止执行，避免后续报错\r\n    }\r\n\r\n    // 2. 校验容器尺寸\r\n    const rect = graphRef.value.getBoundingClientRect();\r\n    if (rect.width === 0 || rect.height === 0) {\r\n      ElMessage.error('图谱容器无有效尺寸，请检查布局！');\r\n      loading.value = false;\r\n      return; // 终止执行\r\n    }\r\n\r\n    // 3.确定当前实体（强制处理空值）\r\n    let entity = typeof targetEntity === 'string' ? targetEntity.trim() : '';\r\n    // 关键：如果明确传递空字符串，强制使用空实体（覆盖父组件传递的实体）\r\n    entity = targetEntity === '' ? '' : (entity || currentEntity.value || props.mainEntity);\r\n    currentEntity.value = entity;\r\n    emit('update:currentEntity', entity);\r\n\r\n    // 4. 获取图谱数据\r\n    let res;\r\n    try {\r\n      if (entity) {\r\n        res = await api.getGraphDataByEntity(entity);\r\n      } else {\r\n        // 无实体：强制调用全量接口（核心修复）\r\n      res = await api.getGraphData();\r\n      console.log('加载全量图谱数据：', res.data); // 调试日志\r\n      }\r\n    } catch (dataError) {\r\n      ElMessage.error(`获取图谱数据失败：${dataError.message}`);\r\n      loading.value = false;\r\n      return; // 数据获取失败，终止执行\r\n    }\r\n\r\n    const { nodes, edges } = res.data;\r\n\r\n    // 5. 校验数据有效性\r\n    if (!nodes || !nodes.length) {\r\n      ElMessage.warning(entity ? `未找到「${entity}」相关图谱数据` : '暂无图谱数据');\r\n      loading.value = false;\r\n      return; // 无数据，终止执行\r\n    }\r\n\r\n    // 6. 格式化数据\r\n    const visNodes = new DataSet(\r\n      nodes.map(node => ({\r\n        id: node.id || node.label,\r\n        label: node.label || node.id,\r\n        shape: 'ellipse',\r\n        size: 25,\r\n        color: { \r\n          background: node.id === entity ? '#67C23A' : '#409EFF',\r\n          border: node.id === entity ? '#529B2E' : '#1989FA' \r\n        }\r\n      }))\r\n    );\r\n\r\n    const visEdges = new DataSet(\r\n      edges.map(edge => ({\r\n        from: edge.from,\r\n        to: edge.to,\r\n        label: edge.label || edge.relation,\r\n        width: 2,\r\n        color: '#999',\r\n        arrows: { to: { enabled: true, scaleFactor: 0.7 } }\r\n      }))\r\n    );\r\n\r\n    // 7. 图谱配置\r\n    const options = {\r\n      nodes: { font: { size: 14, color: '#333' } },\r\n      edges: { font: { size: 12, align: 'middle' } },\r\n      physics: {\r\n        enabled: true,\r\n        stabilization: { enabled: true, iterations: 500, fit: true },\r\n        barnesHut: {\r\n          gravitationalConstant: -2000,\r\n          centralGravity: 0.3,\r\n          springLength: 200,\r\n          springConstant: 0.04,\r\n          damping: 0.09,\r\n          avoidOverlap: 0.1\r\n        }\r\n      },\r\n      interaction: { \r\n        hover: true, \r\n        tooltipDelay: 200,\r\n        dragNodes: true,\r\n        zoomView: true\r\n      }\r\n    };\r\n\r\n    // 8. 创建图谱实例（核心：确保实例创建成功）\r\n    try {\r\n      network.value = new Network(graphRef.value, { nodes: visNodes, edges: visEdges }, options);\r\n    } catch (initError) {\r\n      ElMessage.error(`图谱实例创建失败：${initError.message}`);\r\n      loading.value = false;\r\n      return; // 实例创建失败，终止执行\r\n    }\r\n\r\n    // 9. 绑定事件（关键：先校验network.value非空）\r\n    if (network.value) {\r\n      // 绑定稳定完成事件\r\n      network.value.on('stabilizationIterationsDone', () => {\r\n        loading.value = false;\r\n        network.value?.setOptions({ physics: { enabled: true } }); // 可选链操作\r\n        // 聚焦核心实体（增加非空校验）\r\n        if (entity && network.value) {\r\n          network.value.focus(entity, { scale: 1.2, animation: true });\r\n        }\r\n      });\r\n\r\n      // 绑定节点点击事件\r\n      network.value.on('click', (params) => {\r\n        if (params.nodes.length > 0 && network.value) { // 非空校验\r\n          const nodeId = params.nodes[0];\r\n          searchEntity.value = nodeId;\r\n          handleSearch(); // 直接调用，不传递参数\r\n        }\r\n      });\r\n    }\r\n\r\n  } catch (error) {\r\n    ElMessage.error(`图谱初始化失败：${error.message}`);\r\n    loading.value = false;\r\n    destroyNetwork(); // 异常时销毁实例\r\n  }\r\n};\r\n\r\n// 处理搜索（移除参数，避免接收KeyboardEvent）\r\nconst handleSearch = () => {\r\n  let entity = searchEntity.value.trim();\r\n  // 过滤非法字符\r\n  entity = entity.replace(/\\[object .+\\]/g, '').trim();\r\n  if (!entity) {\r\n    ElMessage.warning('请输入有效的节点名称！');\r\n    return;\r\n  }\r\n  currentEntity.value = entity;\r\n  initGraph(entity);\r\n};\r\n\r\n// 显示全量图谱（完整重置状态）\r\nconst showAllGraph = () => {\r\n  // 1. 清空搜索框\r\n  searchEntity.value = '';\r\n  // 2. 重置当前实体（关键：彻底清除实体状态）\r\n  currentEntity.value = '';\r\n  // 3. 通知父组件清除实体（确保联动状态一致）\r\n  emit('update:currentEntity', '');\r\n  // 4. 强制加载全量数据（传递空字符串明确标识全量）\r\n  initGraph('');\r\n};\r\n\r\n// 监听问答面板实体变化（增加防抖）\r\nwatch(\r\n  () => props.mainEntity,\r\n  (newEntity) => {\r\n    if (!currentEntity.value) {\r\n      initGraph(newEntity);\r\n    }\r\n  },\r\n  { immediate: true, flush: 'post' } // 延迟执行，确保DOM更新\r\n);\r\n\r\n// 挂载后初始化（增加延迟，确保DOM渲染完成）\r\nonMounted(async () => {\r\n  await nextTick();\r\n  setTimeout(() => {\r\n    initGraph();\r\n  }, 300); // 延迟300ms，兼容慢渲染场景\r\n\r\n  // 窗口resize监听（增加非空校验）\r\n  window.addEventListener('resize', () => {\r\n    if (network.value) {\r\n      network.value.redraw();\r\n    }\r\n  });\r\n  // 新增：绑定全屏事件监听\r\n  document.addEventListener('fullscreenchange', handleFullScreenChange);\r\n  document.addEventListener('webkitfullscreenchange', handleFullScreenChange);\r\n  document.addEventListener('msfullscreenchange', handleFullScreenChange);\r\n});\r\n// 新增：全屏切换核心方法\r\nconst toggleFullScreen = () => {\r\n  // 获取图谱容器DOM\r\n  const container = document.querySelector('.graph-container');\r\n  if (!container) return;\r\n\r\n  try {\r\n    if (!isFullScreen.value) {\r\n      // 进入全屏（兼容多浏览器）\r\n      if (container.requestFullscreen) {\r\n        container.requestFullscreen();\r\n      } else if (container.webkitRequestFullscreen) { // Chrome/Safari\r\n        container.webkitRequestFullscreen();\r\n      } else if (container.msRequestFullscreen) { // IE/Edge\r\n        container.msRequestFullscreen();\r\n      }\r\n      ElMessage.success('已进入图谱全屏模式，按ESC键可退出');\r\n    } else {\r\n      // 退出全屏（兼容多浏览器）\r\n      if (document.exitFullscreen) {\r\n        document.exitFullscreen();\r\n      } else if (document.webkitExitFullscreen) {\r\n        document.webkitExitFullscreen();\r\n      } else if (document.msExitFullscreen) {\r\n        document.msExitFullscreen();\r\n      }\r\n      ElMessage.info('已退出图谱全屏模式');\r\n    }\r\n  } catch (error) {\r\n    ElMessage.error(`全屏操作失败：${error.message}`);\r\n  }\r\n};\r\n\r\n// 新增：监听全屏状态变化（同步isFullScreen，并重绘图谱）\r\nconst handleFullScreenChange = () => {\r\n  // 检测当前是否处于全屏状态（兼容多浏览器）\r\n  const fullscreenElement = document.fullscreenElement || \r\n                            document.webkitFullscreenElement || \r\n                            document.msFullscreenElement;\r\n  isFullScreen.value = !!fullscreenElement;\r\n  \r\n  // 全屏状态变化时重绘图谱，避免尺寸异常\r\n  if (network.value) {\r\n    network.value.redraw();\r\n  }\r\n};\r\n// 卸载时销毁（增加非空校验）\r\nonUnmounted(() => {\r\n  destroyNetwork();\r\n  window.removeEventListener('resize', () => {});\r\n});\r\n</script>\r\n\r\n<style scoped>\r\n/* 原有loading样式保留 */\r\n.loading {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: rgba(255, 255, 255, 0.8);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 10;\r\n  font-size: 16px;\r\n  color: #666;\r\n}\r\n\r\n/* 新增：全屏状态下的容器样式 */\r\n.graph-container.fullscreen {\r\n  position: fixed !important;\r\n  top: 0 !important;\r\n  left: 0 !important;\r\n  width: 100vw !important;\r\n  height: 100vh !important;\r\n  z-index: 9999 !important;\r\n  background: white !important;\r\n  border: none !important;\r\n  margin: 0 !important;\r\n  padding: 20px !important;\r\n}\r\n\r\n/* 新增：全屏状态下的图谱内容区样式 */\r\n.graph-container.fullscreen >>> .vis-network {\r\n  width: 100% !important;\r\n  height: 100% !important;\r\n}\r\n</style>"],"mappings":";;EACOA,KAAK,EAAC,eAAe;EAACC,KAAuD,EAAvD;IAAA;IAAA;IAAA;EAAA;;;EACpBD,KAAK,EAAC,YAAY;EAACC,KAAsD,EAAtD;IAAA;IAAA;IAAA;EAAA;;;;EAsBFD,KAAK,EAAC;;;EAIxBE,GAAG,EAAC,UAAU;EACdD,KAAiF,EAAjF;IAAA;IAAA;IAAA;IAAA;EAAA;;;uBA5BNE,mBAAA,CAsCM,OAtCNC,UAsCM,GArCJC,mBAAA,CAkBM,OAlBNC,UAkBM,GAjBJC,YAAA,CAMYC,MAAA;gBALDA,MAAA,CAAAC,YAAY;+DAAZD,MAAA,CAAAC,YAAY,GAAAC,MAAA;IACrBC,WAAW,EAAC,yBAAyB;IACrCC,SAAS,EAAT,EAAS;IACTX,KAAgB,EAAhB;MAAA;IAAA,CAAgB;IACfY,OAAK,EAAAC,SAAA,CAAQN,MAAA,CAAAO,YAAY;2CAE5BR,YAAA,CAA8DC,MAAA;IAAnDQ,IAAI,EAAC,SAAS;IAAEC,OAAK,EAAET,MAAA,CAAAO;;sBAAc,MAAE,KAAAG,MAAA,QAAAA,MAAA,O,iBAAF,IAAE,mB;;MAClDX,YAAA,CAAiDC,MAAA;IAArCS,OAAK,EAAET,MAAA,CAAAW;EAAY;sBAAE,MAAI,KAAAD,MAAA,QAAAA,MAAA,O,iBAAJ,MAAI,mB;;MACrCE,mBAAA,kBAAqB,EACrBb,YAAA,CAMeC,MAAA;IALbQ,IAAI,EAAC,SAAS;IACbC,OAAK,EAAET,MAAA,CAAAa,gBAAgB;IACxBC,IAAI,EAAC,YAAY;IACjBC,MAAM,EAAN,EAAM;IACNC,KAAK,EAAC;;sBACP,MAAE,KAAAN,MAAA,QAAAA,MAAA,O,iBAAF,IAAE,mB;;QAGLE,mBAAA,gCAAmC,EACnCf,mBAAA,CAeM;IAfAL,KAAK,EAAAyB,eAAA;MAAA,cAAsCjB,MAAA,CAAAkB;IAAY;IAAKzB,KAAuD,EAAvD;MAAA;MAAA;MAAA;IAAA;MACrDO,MAAA,CAAAmB,OAAO,I,cAAlBxB,mBAAA,CAEM,OAFNyB,UAEM,EAAAC,gBAAA,CADDrB,MAAA,CAAAsB,aAAa,SAAStB,MAAA,CAAAsB,aAAa,6C,mCAExCzB,mBAAA,CAGO,OAHP0B,UAGO,+BACPxB,YAAA,CAMYC,MAAA;IALVQ,IAAI,EAAC,MAAM;IACVC,OAAK,EAAET,MAAA,CAAAwB,SAAS;IACjB/B,KAAsD,EAAtD;MAAA;MAAA;MAAA;IAAA;;sBACD,MAED,KAAAiB,MAAA,QAAAA,MAAA,O,iBAFC,QAED,mB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}